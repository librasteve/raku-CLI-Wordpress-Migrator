#!/usr/bin/env raku
use v6.d;

use DateTime::Format;
use CLI::Wordpress::Migrator;
use CLI::Wordpress::Migrator::Exporter;

say my $now = strftime('%Y%m%d-%H-%M-%S', DateTime.now);



my $server = Server.new: :name<from>;
dd $server;

my $e = Exporter.new: :$server, :$now;
say $e.perl;


exit;

#my $user     = 'myusername';
#my $domain   = 'mydomain.com';
#my $subdom   = 'sdname';
#my $key-pub  = 'kpname';
#my $port     = 22;
#
#my $bu-dir   = "$subdom.backup";
#my $wp-dir   = "$subdom.$domain" ;
#
#my $login    = "$user@$domain";
#my $home-path = "/home/$user";
#my $key-dir  = '~/.ssh';
#my $key-path = "$key-dir/$key-pub";

## spawn process and ssh connect it
#my $proc = Proc::Async.new: :w, qqw|ssh -p $port -tt -i $key-path $login|;
#
## subscribe to new output from out and err handles:
#$proc.stdout.tap(-> $v { print "Output: $v" });
#$proc.stderr.tap(-> $v { print "Error:  $v" });


#sub perl {
#    my $code = q:to/END/;
#    #!/usr/bin/perl
#    use strict;
#    use warnings;
#
#    print "Doing backup at %NOW%\n";
#
#    my $sql_file = "backup-db-%NOW%.sql";
#    `wp db --path='../%WP-DIR%' export $sql_file`;
#
#    my $tar_file = "backup-fs-%NOW%.tar.gz";
#    `tar -czf $tar_file ../%WP-DIR%/wp-content`;
#    END
#
#    $code ~~ s:g/'%NOW%'   /$now/;
#    $code ~~ s:g/'%WP-DIR%'/$wp-dir/;
#
#    $code
#}




#`[

UPLOAD exporter.pl

#rsync -e "ssh -p 22" -va . myusername@mydomain.com:/home/myusername/sdname.mydomain.com

(will need to use some variant of expect to send pwd)


RUN

remote run exporter.pl

DOWNLOAD

scp -P 22 -r myusername@mydomain.com:/home/myusername/sdname.mydomain.com/backup-fs-20240613-09-30-26.tar.gz .
scp -P 22 -r myusername@mydomain.com:/home/myusername/sdname.mydomain.com/backup-db-20240613-09-30-26.sql .

(will need to use some variant of expect to send pwd)

CLEANUP

probably shouldnt have any files in public dir

#]

# DATABASE




